name: DevOps Cloud AI Dashboard

on:
  schedule:
    - cron: "0 */6 * * *"   # every 6 hours
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-dashboard:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Generate Dashboard SVG
        run: |
          mkdir -p dist
          python3 << 'EOF'
          from datetime import datetime
          import random
          import math

          now = datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")

          cicd = random.randint(80, 99)
          deploys = random.randint(40, 90)
          uptime = 99.7 + random.random() * 0.3
          cost = random.randint(60, 95)
          ai = random.randint(85, 98)

          status = "Healthy" if cicd > 85 and uptime > 99.9 else "Degraded"
          status_color = "#22c55e" if status == "Healthy" else "#f97316"

          r = 42
          circ = 2 * math.pi * r
          offset = circ * (1 - ai / 100)

          svg = f"""
          <svg width="900" height="520" viewBox="0 0 900 520"
               xmlns="http://www.w3.org/2000/svg">

          <defs>
            <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#020617"/>
              <stop offset="100%" stop-color="#0f172a"/>
            </linearGradient>
          </defs>

          <style>
            text {{ font-family: Inter, system-ui; }}
            .title {{ fill:#e5e7eb; font-size:28px; font-weight:800; }}
            .label {{ fill:#94a3b8; font-size:13px; }}
            .value {{ fill:#f8fafc; font-size:30px; font-weight:700; }}
            .panel {{ fill:#020617; stroke:#1e293b; stroke-width:1; rx:14; }}
          </style>

          <rect width="100%" height="100%" fill="url(#bg)" rx="20"/>

          <text x="40" y="50" class="title">DevOps • Cloud • AI Dashboard</text>
          <circle cx="690" cy="42" r="6" fill="{status_color}">
            <animate attributeName="opacity" values="1;0.4;1" dur="2s" repeatCount="indefinite"/>
          </circle>
          <text x="705" y="48" class="label">{status}</text>
          <text x="40" y="75" class="label">Updated: {now}</text>

          <!-- Metrics -->
          <rect x="40" y="100" width="250" height="110" class="panel"/>
          <text x="60" y="130" class="label">CI/CD Success</text>
          <text x="60" y="175" class="value">{cicd}%</text>

          <rect x="325" y="100" width="250" height="110" class="panel"/>
          <text x="345" y="130" class="label">Deployments</text>
          <text x="345" y="175" class="value">{deploys}</text>

          <rect x="610" y="100" width="250" height="110" class="panel"/>
          <text x="630" y="130" class="label">Cloud Uptime</text>
          <text x="630" y="175" class="value">{uptime:.2f}%</text>

          <!-- AI Gauge -->
          <rect x="40" y="240" width="820" height="230" class="panel"/>
          <text x="60" y="270" class="label">AI Model Accuracy</text>

          <circle cx="450" cy="360" r="{r}" stroke="#1e293b" stroke-width="8" fill="none"/>
          <circle cx="450" cy="360" r="{r}"
                  stroke="#22c55e"
                  stroke-width="8"
                  fill="none"
                  stroke-dasharray="{circ}"
                  stroke-dashoffset="{offset}"
                  transform="rotate(-90 450 360)"
                  stroke-linecap="round">
            <animate attributeName="stroke-dashoffset"
                     from="{circ}" to="{offset}"
                     dur="1.4s" fill="freeze"/>
          </circle>

          <text x="450" y="368" text-anchor="middle" class="value">{ai}%</text>
          <text x="450" y="395" text-anchor="middle" class="label">Accuracy</text>

          </svg>
          """

          with open("dist/dashboard.svg", "w") as f:
              f.write(svg)

          print("Dashboard SVG generated")
          EOF

      - name: Publish to output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
