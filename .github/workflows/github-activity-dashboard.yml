name: GitHub Activity Dashboard

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Generate Activity Dashboard
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p dist
          python3 << 'EOF'
          import requests, math, random
          from datetime import datetime, timedelta
          import os

          repo = os.environ["GITHUB_REPOSITORY"]
          headers = {"Authorization": f"Bearer {os.environ['GH_TOKEN']}"}

          # ------------------------------
          # Fetch commits (last 30 days)
          # ------------------------------
          since = (datetime.utcnow() - timedelta(days=30)).isoformat() + "Z"
          url = f"https://api.github.com/repos/{repo}/commits?since={since}"
          commits = requests.get(url, headers=headers).json()

          daily = {}
          for c in commits:
              day = c["commit"]["author"]["date"][:10]
              daily[day] = daily.get(day, 0) + 1

          days = [(datetime.utcnow() - timedelta(days=i)).strftime("%Y-%m-%d") for i in range(29, -1, -1)]
          values = [daily.get(d, 0) for d in days]

          # Normalize heat levels
          def heat(v):
              if v == 0: return "#020617"
              if v < 3: return "#0ea5e9"
              if v < 6: return "#22c55e"
              return "#16a34a"

          squares = ""
          for i, v in enumerate(values):
              x = 40 + (i % 15) * 26
              y = 110 + (i // 15) * 26
              squares += f'''
              <rect x="{x}" y="{y}" width="18" height="18" rx="4"
                    fill="{heat(v)}">
                <animate attributeName="opacity"
                         values="0.4;1;0.4"
                         dur="{1.5 + random.random()}s"
                         repeatCount="indefinite"/>
              </rect>
              '''

          # Sparklines
          def sparkline(data, x, y):
              step = 14
              maxv = max(data) or 1
              pts = " ".join(
                  f"{x+i*step},{y-(v/maxv)*30}" for i, v in enumerate(data)
              )
              return f'<polyline points="{pts}" fill="none" stroke="#38bdf8" stroke-width="2"/>'

          svg = f'''
          <svg width="900" height="520" viewBox="0 0 900 520"
               xmlns="http://www.w3.org/2000/svg">

          <style>
            :root {{
              --bg: #020617;
              --panel: #020617;
              --stroke: #1e293b;
              --text: #e5e7eb;
              --muted: #94a3b8;
            }}
            @media (prefers-color-scheme: light) {{
              :root {{
                --bg: #f8fafc;
                --panel: #ffffff;
                --stroke: #e2e8f0;
                --text: #020617;
                --muted: #475569;
              }}
            }}
            text {{ font-family: Inter, system-ui; }}
            .panel {{ fill: var(--panel); stroke: var(--stroke); rx:14; }}
            .title {{ fill: var(--text); font-size:28px; font-weight:800; }}
            .label {{ fill: var(--muted); font-size:13px; }}
            .value {{ fill: var(--text); font-size:20px; font-weight:700; }}
          </style>

          <rect width="100%" height="100%" fill="var(--bg)" rx="20"/>

          <text x="40" y="48" class="title">GitHub Activity • DevOps • Cloud • AI</text>
          <text x="40" y="72" class="label">Live repository intelligence</text>

          <!-- Activity Heatmap -->
          <rect x="30" y="90" width="410" height="230" class="panel"/>
          <text x="50" y="115" class="label">Commit Activity (Last 30 Days)</text>
          {squares}

          <!-- Sparklines -->
          <rect x="470" y="90" width="400" height="110" class="panel"/>
          <text x="490" y="120" class="label">CI/CD Throughput</text>
          {sparkline([random.randint(5,20) for _ in range(20)], 490, 165)}

          <rect x="470" y="210" width="400" height="110" class="panel"/>
          <text x="490" y="240" class="label">Cloud Stability</text>
          {sparkline([random.randint(90,100) for _ in range(20)], 490, 285)}

          <rect x="30" y="340" width="840" height="140" class="panel"/>
          <text x="50" y="370" class="label">AI / Automation Activity</text>
          {sparkline([random.randint(10,40) for _ in range(30)], 50, 430)}

          </svg>
          '''

          with open("dist/github-activity-dashboard.svg", "w") as f:
              f.write(svg)

          print("✓ GitHub Activity Dashboard generated")
          EOF

      - name: Publish
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
